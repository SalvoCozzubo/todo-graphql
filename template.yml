Transform: AWS::Serverless-2016-10-31

Resources:
  TodoDynamoDb:
    Type: AWS::Serverless::SimpleTable
    Properties:
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1
  GraphQLResolverCreateTodo:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQLEndpoint.ApiId
      FieldName: "createTodo"
      TypeName: "Mutation"
      DataSourceName: !GetAtt TodoDataSource.Name
      ResponseMappingTemplateS3Location: ./graphql/createTodo/responseMapping.vtl
      RequestMappingTemplateS3Location: ./graphql/createTodo/requestMapping.vtl
  GraphQLResolverListTodo:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQLEndpoint.ApiId
      FieldName: "listTodos"
      TypeName: "Query"
      DataSourceName: !GetAtt TodoDataSource.Name
      ResponseMappingTemplateS3Location: ./graphql/listTodos/responseMapping.vtl
      RequestMappingTemplateS3Location: ./graphql/listTodos/requestMapping.vtl
  GraphQLSchema:
    Type: AWS::AppSync::GraphQLSchema
    Properties:
      ApiId: !GetAtt GraphQLEndpoint.ApiId
      DefinitionS3Location: ./graphql/schema.graphql
  TodoDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQLEndpoint.ApiId
      Type: AMAZON_DYNAMODB
      Name: TodoDataSource
      ServiceRoleArn: !GetAtt TodoDataSourceServiceRole.Arn
      DynamoDBConfig:
        AwsRegion: !Ref AWS::Region
        TableName: !Ref TodoDynamoDb
  GraphQLApiKey:
    Type: AWS::AppSync::ApiKey
    Properties:
      ApiId: !GetAtt GraphQLEndpoint.ApiId
  GraphQLEndpoint:
    Type: AWS::AppSync::GraphQLApi
    Properties:
      AuthenticationType: API_KEY
      Name: TodoApi
  TodoDataSourceServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - appsync.amazonaws.com
            Action:
              - "sts:AssumeRole"
      Policies:
        -
          PolicyName: DynamoDbWriteRead
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              -
                Effect: "Allow"
                Action:
                  - "dynamodb:BatchGetItem"
                  - "dynamodb:BatchWriteItem"
                  - "dynamodb:PutItem"
                  - "dynamodb:DeleteItem"
                  - "dynamodb:GetItem"
                  - "dynamodb:Scan"
                  - "dynamodb:Query"
                  - "dynamodb:UpdateItem"
                Resource:
                  - !GetAtt TodoDynamoDb.Arn
                  - !Join [ "", [!GetAtt TodoDynamoDb.Arn, "/*"]]
Outputs:
  GraphQLUrl:
    Value: !GetAtt GraphQLEndpoint.GraphQLUrl
  ApiKey:
    Value: !GetAtt GraphQLApiKey.ApiKey
  Region:
    Value: !Ref AWS::Region
  AuthType:
    Value: API_KEY
  Version:
    Value: 5
